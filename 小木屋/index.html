<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>å°æœ¨å±‹è¿˜äº®ç€</title>

  <style>
    /* âœ… ä½ ç¡®è®¤è¿‡çš„å®šä½å˜é‡ï¼ˆä¸æ”¹ï¼‰ */
    :root{
      --doorX: 63.5%;
      --doorY: 4px;
      --restX: -88px;  /* èº²åœ¨å±‹é‡Œ */
      --headX: -74px;  /* åŠå¤´ */
      --halfX: -67px;  /* åŠèº« */
      --outX:  -46px;  /* å…¨èº« */

      --bounceAuto: 1;
      --bounceX: -52px; /* è¯±æƒ‘æˆåŠŸåè·³åŠ¨æ›´å¾€é—¨æ´é‡Œä¸€ç‚¹ï¼ˆä½ è¯´ out å¤ªé å³ï¼‰ */

      /* ä¸»é¢˜å˜é‡ï¼ˆJSä¼šæŒ‰æ—¶æ®µè¦†ç›–ï¼‰ */
      --sky1:#9ad7ff;
      --sky2:#eef9ff;

      --panel-bg: rgba(255,255,255,.22);
      --panel-brd: rgba(255,255,255,.30);

      --txt: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.55);

      /* iMessage æ°”æ³¡ */
      --bubble-left-bg: rgba(235,235,240,.92);  /* å·¦ä¾§ç° */
      --bubble-left-txt: rgba(0,0,0,.92);
      --bubble-right-bg: rgba(0,122,255,.95);   /* å³ä¾§è“ */
      --bubble-right-txt: rgba(255,255,255,.96);

      --input-bg: rgba(255,255,255,.55);
      --input-brd: rgba(0,0,0,.10);
      --input-txt: rgba(0,0,0,.88);

      --btn-bg: rgba(255,255,255,.45);
      --btn-brd: rgba(0,0,0,.10);
      --btn-txt: rgba(0,0,0,.86);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      height:100vh;
      overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans GB","Noto Sans SC",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(180deg,var(--sky1),var(--sky2));
      color: var(--txt);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
      transition: background 700ms ease;
    }

    /* ===== èƒŒæ™¯å±‚ï¼šäº‘/æ˜Ÿ/æœˆ ===== */
    #sky{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }
    #clouds{
      position:absolute; inset:-10%;
      opacity:1;
      transition: opacity .6s ease;
    }
    .cloud{
      position:absolute;
      width:220px; height:120px;
      background: rgba(255,255,255,.65);
      border-radius:999px;
      box-shadow:
        70px 10px 0 rgba(255,255,255,.60),
        130px 25px 0 rgba(255,255,255,.55),
        35px 35px 0 rgba(255,255,255,.50);
      opacity:.9;
      animation: floatCloud 42s linear infinite;
    }
    .cloud.c2{ transform:scale(1.2); opacity:.75; animation-duration:58s; }
    .cloud.c3{ transform:scale(.9); opacity:.70; animation-duration:70s; }
    @keyframes floatCloud{
      0%{ transform: translateX(-30%); }
      100%{ transform: translateX(160%); }
    }

    #stars{
      position:absolute; inset:0;
      opacity:0;
      transition: opacity .6s ease;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.9) 1px, transparent 2px) 0 0/140px 140px,
        radial-gradient(circle at 70% 40%, rgba(255,255,255,.7) 1px, transparent 2px) 0 0/180px 180px,
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.8) 1px, transparent 2px) 0 0/220px 220px;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.25));
    }
    #moon{
      position:absolute;
      width:110px; height:110px;
      border-radius:50%;
      top: 8%;
      right: 10%;
      opacity:0;
      transition: opacity .6s ease;
      background: radial-gradient(circle at 35% 35%, #fff 0%, #f7f3d6 45%, #e7dca6 100%);
      box-shadow: 0 0 40px rgba(255,255,255,.22);
    }
    #moon::after{
      content:"";
      position:absolute; inset:18px;
      border-radius:50%;
      background: radial-gradient(circle at 60% 40%, rgba(0,0,0,.08) 0%, transparent 55%);
      opacity:.6;
    }

    /* ===== åœºæ™¯ï¼ˆå°å±‹+å’ªè’™ï¼‰ ===== */
    .scene{
      position:relative;
      width:360px;
      height:280px;
      z-index:2;
      overflow:hidden;
    }
    .hut-foreground{
      position:absolute;
      left:0; bottom:0;
      width:100%;
      z-index:2;
      pointer-events:none;
    }

    /* å’ªè’™ï¼šåªåš X æ–¹å‘ç§»åŠ¨ */
    #mimeng{
      position:absolute;
      z-index:1;
      width:100px;
      left: var(--doorX);
      bottom: var(--doorY);
      opacity:0;
      filter: brightness(.35);
      transform: translateX(var(--restX)) scale(.95);
      transition: transform .7s cubic-bezier(0.25,0.46,0.45,0.94), opacity .45s ease, filter .45s ease;
      will-change: transform, opacity;
    }
    #mimeng.peek-head{ opacity:1; filter:brightness(1); transform: translateX(var(--headX)) scale(.98); }
    #mimeng.peek-half{ opacity:1; filter:brightness(1); transform: translateX(var(--halfX)) scale(1); }
    #mimeng.out{       opacity:1; filter:brightness(1.25); transform: translateX(var(--outX)) scale(1); }
    #mimeng.hidden{ opacity:0 !important; }

    /* è·³åŠ¨ï¼šç¡®ä¿åœ¨é—¨æ´èŒƒå›´å†…è·³ */
    @keyframes happy-bounce{
      0%,100% { transform: translateX(var(--outX)) translateY(0) rotate(0deg) scale(1); }
      50%     { transform: translateX(var(--bounceX)) translateY(-10px) rotate(5deg) scale(1); }
    }
    .is-happy{ animation: happy-bounce .42s ease 2 !important; }

    /* è¹‚èºå¤§å›¾ */
    #mimeng-close-up{
      position:fixed;
      top:45%;
      left:50%;
      width:320px;
      z-index:1000;
      transform: translate(-50%,-50%) scale(0);
      transition: transform .25s ease, opacity .25s ease;
      filter: drop-shadow(0 0 50px rgba(0,0,0,.85));
      pointer-events:none;
      opacity:0;
    }
    #mimeng-close-up.show{
      opacity:1;
      transform: translate(-50%,-50%) scale(1);
      animation: struggle-vibrate .10s infinite;
    }
    @keyframes struggle-vibrate{
      0%,100%{ transform: translate(-50%,-50%) rotate(0deg) scale(1); }
      25%{ transform: translate(-51%,-51%) rotate(-2deg) scale(1); }
      75%{ transform: translate(-49%,-49%) rotate( 2deg) scale(1); }
    }

    /* ===== iMessage å¯¹è¯é¢æ¿ ===== */
    .panel{
      width:min(94vw, 520px);
      border-radius:24px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-brd);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      z-index:3;
      overflow:hidden;
    }
    .panel-header{
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      font-weight:700;
      letter-spacing:.2px;
      color: var(--txt);
    }
    .small-sub{
      position:absolute;
      right:12px;
      font-size:12px;
      font-weight:650;
      color: var(--muted);
    }

    #chat-history{
      height: 240px;
      padding: 14px 12px 10px;
      overflow-y:auto;
      scroll-behavior:smooth;
    }

    .msg-row{
      display:flex;
      align-items:flex-end;
      gap:8px;
      margin: 8px 0;
    }
    .msg-row.left{ justify-content:flex-start; }
    .msg-row.right{ justify-content:flex-end; }

    .avatar{
      width:28px; height:28px;
      border-radius:50%;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.45);
      flex:0 0 auto;
    }
    .avatar img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }

    .bubble{
      max-width: 74%;
      padding: 10px 12px;
      border-radius: 18px;
      line-height: 1.35;
      font-size: 14px;
      word-break: break-word;
      white-space: pre-wrap;
      position:relative;
    }
    .bubble.left{
      background: var(--bubble-left-bg);
      color: var(--bubble-left-txt);
      border-bottom-left-radius: 8px;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
    }
    .bubble.right{
      background: var(--bubble-right-bg);
      color: var(--bubble-right-txt);
      border-bottom-right-radius: 8px;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }

    .panel-footer{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .btn-group{
      display:flex;
      justify-content:center;
      gap:10px;
    }
    button{
      border:none;
      padding: 9px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      background: var(--btn-bg);
      border:1px solid var(--btn-brd);
      color: var(--btn-txt);
      user-select:none;
    }
    .btn-knock{ background:#ff8a2a; border:none; color:#1a1207; }
    .btn-feed{  background:#5b6cff; border:none; color:#fff; }
    .btn-touch{ background:#8e44ad; border:none; color:#fff; }
    button:active{ transform: translateY(1px); }

    .input-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    #userInput{
      flex:1;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid var(--input-brd);
      background: var(--input-bg);
      color: var(--input-txt);
      outline:none;
      font-size: 14px;
    }
    #sendBtn{
      padding: 12px 16px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.18);
      font-weight:800;
    }

    /* ===== ä¸»é¢˜ï¼šéšæ—¶æ®µè‡ªåŠ¨åˆ‡æ¢ï¼ˆä¿è¯çœ‹å¾—æ¸…ï¼‰ ===== */
    body.theme-day{
      --sky1:#9ad7ff; --sky2:#eef9ff;

      --panel-bg: rgba(255,255,255,.28);
      --panel-brd: rgba(255,255,255,.42);
      --txt: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.55);

      --bubble-left-bg: rgba(235,235,240,.95);
      --bubble-left-txt: rgba(0,0,0,.92);
      --bubble-right-bg: rgba(0,122,255,.95);
      --bubble-right-txt: rgba(255,255,255,.97);

      --input-bg: rgba(255,255,255,.65);
      --input-brd: rgba(0,0,0,.10);
      --input-txt: rgba(0,0,0,.88);

      --btn-bg: rgba(255,255,255,.55);
      --btn-brd: rgba(0,0,0,.10);
      --btn-txt: rgba(0,0,0,.86);
    }
    body.theme-dusk{
      --sky1:#ffd1a8; --sky2:#6b6cff;

      --panel-bg: rgba(18,18,26,.26);
      --panel-brd: rgba(255,255,255,.20);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --bubble-left-bg: rgba(40,40,55,.65);
      --bubble-left-txt: rgba(255,255,255,.94);
      --bubble-right-bg: rgba(0,122,255,.92);
      --bubble-right-txt: rgba(255,255,255,.97);

      --input-bg: rgba(0,0,0,.28);
      --input-brd: rgba(255,255,255,.18);
      --input-txt: rgba(255,255,255,.92);

      --btn-bg: rgba(255,255,255,.16);
      --btn-brd: rgba(255,255,255,.18);
      --btn-txt: rgba(255,255,255,.92);
    }
    body.theme-night{
      --sky1:#0b1020; --sky2:#02030a;

      --panel-bg: rgba(10,10,15,.42);
      --panel-brd: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --bubble-left-bg: rgba(255,255,255,.16);
      --bubble-left-txt: rgba(255,255,255,.94);
      --bubble-right-bg: rgba(0,122,255,.90);
      --bubble-right-txt: rgba(255,255,255,.97);

      --input-bg: rgba(0,0,0,.35);
      --input-brd: rgba(255,255,255,.14);
      --input-txt: rgba(255,255,255,.92);

      --btn-bg: rgba(255,255,255,.14);
      --btn-brd: rgba(255,255,255,.16);
      --btn-txt: rgba(255,255,255,.92);
    }

    @media (max-width: 380px){
      .scene{ width:340px; height:270px; }
      #chat-history{ height: 220px; }
      .bubble{ max-width: 78%; }
    }
  </style>
</head>

<body class="theme-day">
  <div id="sky">
    <div id="clouds">
      <div class="cloud c1" style="top:12%; left:-30%;"></div>
      <div class="cloud c2" style="top:28%; left:-55%;"></div>
      <div class="cloud c3" style="top:18%; left:-75%;"></div>
    </div>
    <div id="stars"></div>
    <div id="moon"></div>
  </div>

  <div class="scene">
    <img id="mimeng" src="mimeng.jpg" alt="mimeng" />
    <img class="hut-foreground" src="hut.png" alt="hut" />
  </div>

  <img id="mimeng-close-up" src="mimeng_touch.gif" alt="mimeng_touch" />

  <div class="panel">
    <div class="panel-header">
      å’ªè’™
      <span class="small-sub" id="themeLabel">ç™½å¤©</span>
    </div>

    <div id="chat-history"></div>

    <div class="panel-footer">
      <div class="btn-group">
        <button class="btn-knock" onclick="handleKnock()">ğŸ¾ æ•²é—¨</button>
        <button class="btn-feed" onclick="handleFeed()">ğŸ§€ è¯±æƒ‘</button>
        <button class="btn-touch" onclick="handleTouch()">ğŸ’†â€â™‚ï¸ è¹‚èº</button>
      </div>

      <div class="input-row">
        <input id="userInput" type="text" placeholder="è·Ÿå’ªè’™è¯´è¯´è¯..." autocomplete="off" />
        <button id="sendBtn" onclick="sendText()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const mimeng   = document.getElementById('mimeng');
    const closeup  = document.getElementById('mimeng-close-up');
    const history  = document.getElementById('chat-history');
    const input    = document.getElementById('userInput');
    const cloudsEl = document.getElementById('clouds');
    const starsEl  = document.getElementById('stars');
    const moonEl   = document.getElementById('moon');
    const themeLabel = document.getElementById('themeLabel');

    let feedStep = 0;
    let isStruggling = false;
    let lastUserAt = Date.now();
    let lastAutoPingKey = "";

    const STATES = ["peek-head","peek-half","out"];
    const hasState = (s) => mimeng.classList.contains(s);
    function setState(s){
      STATES.forEach(x => mimeng.classList.remove(x));
      if (s) mimeng.classList.add(s);
    }
    function clearHidden(){ mimeng.classList.remove("hidden"); }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function normalize(s){ return (s||"").trim(); }
    function nowHM(){
      const d = new Date();
      return d.getHours()*60 + d.getMinutes();
    }

    /* =========================
       ğŸ§  è®°å¿†æ§½ï¼ˆlocalStorageï¼‰
       ========================= */
    const MEM_KEY = "mimeng_memory_v2";
    function loadMem(){
      try{
        return JSON.parse(localStorage.getItem(MEM_KEY)) || {
          lastCat: "",
          lastFood: "",
          lastTopic: "",
          lastUserText: "",
          counters: { shrimp:0, game:0, sleep:0, water:0, work:0 },
          recentFacts: [],
          updatedAt: Date.now()
        };
      }catch(e){
        return {
          lastCat:"", lastFood:"", lastTopic:"", lastUserText:"",
          counters:{ shrimp:0, game:0, sleep:0, water:0, work:0 },
          recentFacts:[], updatedAt: Date.now()
        };
      }
    }
    function saveMem(mem){
      mem.updatedAt = Date.now();
      localStorage.setItem(MEM_KEY, JSON.stringify(mem));
    }
    let MEM = loadMem();
    function pushFact(text){
      MEM.recentFacts.unshift(text);
      MEM.recentFacts = MEM.recentFacts.slice(0, 8);
      saveMem(MEM);
    }
    function bump(key){
      if (!MEM.counters[key]) MEM.counters[key] = 0;
      MEM.counters[key] += 1;
      saveMem(MEM);
    }
    function updateMemFromUser(raw){
      const v = (raw||"").toLowerCase();
      MEM.lastUserText = raw;

      if (v.includes("å¤§é»„") || v.includes("å†·é…·") || v.includes("çŠŸ")) MEM.lastCat="dahuang";
      if (v.includes("æ¡æ¡") || v.includes("æ­ªå¤´") || v.includes("è„¸ç›˜") || v.includes("èƒ–")) MEM.lastCat="tiaotiao";
      if (v.includes("å¡å¡") || v.includes("ä¸‰é¢—ç‰™") || v.includes("æš–ç”·") || v.includes("åå¿ƒ")) MEM.lastCat="kaka";

      if (v.includes("è™¾") || v.includes("è™¾ç±³")) { MEM.lastFood="shrimp"; bump("shrimp"); pushFact("å¦ˆå¦ˆæåˆ°äº†è™¾ç±³"); }
      if (v.includes("è“è“")) { MEM.lastFood="blueberry"; pushFact("å¦ˆå¦ˆæåˆ°äº†è“è“"); }
      if (v.includes("å†»å¹²") || v.includes("è±†è…")) { MEM.lastFood="tofu"; pushFact("å¦ˆå¦ˆæåˆ°äº†å†»å¹²è±†è…"); }

      if (v.includes("ç¡") || v.includes("ç†¬å¤œ") || v.includes("å›°")) { MEM.lastTopic="sleep"; bump("sleep"); }
      if (v.includes("æ¸¸æˆ") || v.includes("ç§¦å½»") || v.includes("å‡çº§é¤å…")) { MEM.lastTopic="game"; bump("game"); }
      if (v.includes("å–æ°´") || v.includes("æ°´")) { MEM.lastTopic="water"; bump("water"); }
      if (v.includes("å·¥ä½œ") || v.includes("éš¾") || v.includes("åŠ ç­")) { MEM.lastTopic="work"; bump("work"); }

      saveMem(MEM);
    }

    /* =========================
       ğŸŒ¤/ğŸŒ‡/ğŸŒ™ ä¸»é¢˜åˆ‡æ¢
       - 06:00-17:30 ç™½å¤©
       - 17:30-19:30 é»„æ˜
       - 19:30-06:00 å¤œæ™šï¼ˆæœˆäº®æ˜Ÿæ˜Ÿï¼‰
       ========================= */
    function getThemeByTime(){
      const m = nowHM();
      if (m >= 1170 || m < 360) return "night";      // 19:30-06:00
      if (m >= 1050 && m < 1170) return "dusk";      // 17:30-19:30
      return "day";                                  // 06:00-17:30
    }
    function applyTheme(){
      const theme = getThemeByTime();
      document.body.classList.remove("theme-day","theme-dusk","theme-night");
      document.body.classList.add(`theme-${theme}`);

      if (theme === "night"){
        cloudsEl.style.opacity = "0";
        starsEl.style.opacity  = "1";
        moonEl.style.opacity   = "1";
        themeLabel.textContent = "å¤œæ™š";
      } else {
        cloudsEl.style.opacity = "1";
        starsEl.style.opacity  = "0";
        moonEl.style.opacity   = "0";
        themeLabel.textContent = (theme==="dusk") ? "é»„æ˜" : "ç™½å¤©";
      }
    }
    applyTheme();
    setInterval(applyTheme, 60*1000);

    /* =========================
       ğŸ’¬ iMessage æ¸²æŸ“ï¼šå’ªè’™å·¦ï¼ŒçŒªçŒªå³
       ========================= */
    async function addMsg(side, text){
      const row = document.createElement("div");
      row.className = `msg-row ${side}`;

      if (side === "left"){
        const av = document.createElement("div");
        av.className = "avatar";
        const img = document.createElement("img");
        img.src = "mimeng.jpg";
        av.appendChild(img);
        row.appendChild(av);
      }

      const bubble = document.createElement("div");
      bubble.className = `bubble ${side === "left" ? "left" : "right"}`;
      bubble.textContent = "";
      row.appendChild(bubble);

      history.appendChild(row);
      history.scrollTop = history.scrollHeight;

      // âœ… å’ªè’™è¯´è¯ï¼šè‹¥ä¸æ˜¯ outï¼Œå°±å¼ºåˆ¶åŠèº«ï¼ˆå¯¹è¯/æ•²é—¨éƒ½åŠèº«ï¼‰
      if (side === "left" && !hasState("out") && !mimeng.classList.contains("hidden")){
        clearHidden();
        setState("peek-half");
      }

      // æ‰“å­—æœºï¼ˆè½»ä¸€ç‚¹ï¼Œä¸é‚£ä¹ˆâ€œæœºå™¨äººâ€ï¼‰
      for (const ch of text){
        bubble.textContent += ch;
        history.scrollTop = history.scrollHeight;
        await new Promise(r => setTimeout(r, 14));
      }

      // è¯´å®Œ5ç§’ç¼©å›ï¼ˆé™¤é outï¼‰
      if (side === "left"){
        setTimeout(()=>{
          if (hasState("peek-half") && !hasState("out") && !isStruggling){
            setState("");
          }
        }, 5000);
      }
    }

    /* =========================
       ğŸ¹ è§’è‰²è®¾å®šä¸â€œåƒå’ªè’™â€çš„æ‹¼è£…å™¨
       - é¦‹ã€æ‡’ã€é¼»å­çµã€çˆ±è£…å‡¶ä½†å¾ˆé»å¦ˆå¦ˆ
       - ä¼šæçŒ«å“¥å“¥ä»¬çš„æ€§æ ¼
       - ä¼šç”¨æœ€è¿‘è®°å¿†ç»­èŠ
       ========================= */

    const Cats = {
      dahuang: [
        "å¤§é»„å“¥å“¥é‚£ä¸ªå†·é…·boyï¼ŒçŠŸå¾—å¾ˆã€‚æƒ³ä½ æŠ±è¿˜è£…é…·ï¼Œç»å…¸ã€‚",
        "å¤§é»„ï¼šâ€˜æˆ‘ä¸éœ€è¦çˆ±ã€‚â€™ ä½†ä»–å°¾å·´å·²ç»å›å˜äº†ã€‚",
        "åˆ«æƒ¹å¤§é»„ï¼Œä»–ä¸€çŠŸèµ·æ¥ï¼Œè¿æˆ‘éƒ½æ€•ã€‚"
      ],
      tiaotiao: [
        "æ¡æ¡çŸ®èƒ–å“¥å“¥åˆæ­ªå¤´æ€äº†ï¼Œè„¸ç›˜å­å¤§å¾—åƒä¸€é¢å°é¼“ã€‚",
        "æ¡æ¡ä»Šå¤©å¥½å¥‡å¾—è¦å‘½ï¼Œä¸€ç›´ç›¯ç€æˆ‘è·‘è½®ï¼Œåƒåœ¨åšç§‘ç ”ã€‚",
        "æ¡æ¡ä¸€æ­ªå¤´ï¼šæˆ‘å°±çŸ¥é“ä»–åˆæƒ³å·çœ‹æˆ‘çš„ç“œå­ã€‚"
      ],
      kaka: [
        "å¡å¡å“¥å“¥æ˜¯è´´å¿ƒæš–ç”·ï¼Œåªæœ‰ä¸‰é¢—ç‰™ä¹Ÿè¦åŠªåŠ›äº²äº²ä½ ã€‚å¦ˆå¦ˆæœ€åå¿ƒä»–ï¼Œæˆ‘æ‡‚ã€‚",
        "å¡å¡åˆšåˆšåœ¨æ‰¾ä½ ï¼šâ€˜å¦ˆå¦ˆå‘¢ï¼Ÿâ€™ï¼ˆä¸‰é¢—ç‰™å‘èª“ä»–å¾ˆè®¤çœŸï¼‰",
        "ä½ å»æŠ±å¡å¡å§ï¼Œä»–ä¼šæŠŠä½ çš„ç–²æƒ«éƒ½å’¬æ‰ï¼ˆè½»è½»çš„é‚£ç§ï¼‰ã€‚"
      ]
    };

    const Lines = {
      confirm: [
        "ï¼ˆå—…å—…ï¼‰æˆ‘é—»åˆ°å‘³é“äº†â€¦å…ˆç¡®è®¤ä¸€ä¸‹ï¼",
        "ï¼ˆé¼»å°–æŠ–æŠ–ï¼‰å—¯ï¼Ÿè¿™å‘³é“â€¦ä¸å¯¹åŠ²ï¼Œç»™æˆ‘å†é—»ä¸€ç§’ã€‚",
        "åˆ«éª—æˆ‘å–”ï¼Œæˆ‘ç¡®è®¤äº†æ‰å®Œå…¨å‡ºæ¥ã€‚"
      ],
      tasty: [
        "ï¼ˆå’”åš“å’”åš“ï¼‰è¿™ä¸ªä¹Ÿå¤ªé¦™äº†å§ï¼è¿˜è¦ï¼",
        "ï¼ˆå¡æ»¡é¢Šå›Šï¼‰æˆ‘å…ˆå­˜èµ·æ¥â€¦æ™šä¸Šå¸¦å°è·Ÿç­ä¸€èµ·åƒï¼",
        "å¥½åƒåˆ°æˆ‘æƒ³åœ¨é—¨æ´é‡Œè·³èˆã€‚"
      ],
      doing: [
        "ï¼ˆç¿»ç¿»å«æ–™ï¼‰æˆ‘åœ¨æ•´ç†ç“œå­åº“å­˜ã€‚",
        "ï¼ˆè·‘è½®ä¸­ï¼‰æˆ‘åœ¨å¤œè·‘ï¼Œæ¡æ¡åœ¨å·çœ‹ã€‚",
        "ï¼ˆè¶´å¹³ï¼‰æˆ‘åœ¨ç¡è§‰â€¦ä½ æ•²é—¨æˆ‘æ‰é†’ã€‚",
        "ï¼ˆæ­ªå¤´ï¼‰æˆ‘åœ¨æ€è€ƒå°„æ‰‹åº§äº§å“ç»ç†çš„å®‡å®™è®¡åˆ’ã€‚",
        "ï¼ˆæŒ æŒ è„¸ï¼‰åœ¨æƒ³å¦ˆå¦ˆæ˜¯ä¸æ˜¯åˆåœ¨åƒè™¾ç±³ã€‚"
      ],
      nightCare: [
        "åˆ«æŠ å˜´çš®ã€‚æ‰‹æ‰‹æ”¾ä¸‹æ¥ï¼Œæˆ‘ç›¯ç€ä½ ã€‚",
        "å°‘ç©æ¸¸æˆã€‚ç§¦å½»ä¸ä¼šé™ªä½ ç¡è§‰ï¼Œå¿«å»æŠ±å¡å¡å“¥å“¥ç¡ã€‚",
        "ä½ å†ç†¬å¤œï¼Œæˆ‘å°±æŠŠç“œå­å¡ä½ æ•å¤´é‡Œç¡Œä½ ï¼ˆå¼€ç©ç¬‘â€¦ä¸€ç‚¹ç‚¹ï¼‰ã€‚"
      ],
      dayCare: [
        "å–æ°´ï¼ä¸¤å£ä¹Ÿè¡Œã€‚æˆ‘ç›¯ç€ã€‚",
        "åˆé¥­åƒäº†å—ï¼Ÿä¸è®¸æ•·è¡ã€‚",
        "åä¹…äº†è¦èµ·æ¥èµ°äº”åˆ†é’Ÿï¼Œä¸ç„¶è…°ä¼šæŠ—è®®ã€‚"
      ],
      shrimp: [
        "åˆæ˜¯è™¾ç±³ï¼å¦ˆå¦ˆä½ æ˜¯è¦æŠŠè‡ªå·±åƒæˆä¸€åªæ¼‚äº®çš„å¤§è™¾ç±³å—ï¼Ÿ",
        "ä»Šå¤©æœ‰è™¾ç±³å—ï¼Ÿæˆ‘æ‰¿è®¤ï¼šæˆ‘é¦‹ã€‚",
        "è™¾ç±³å‘³ä¸€å‡ºæ¥ï¼Œæˆ‘å°±æ²¡éª¨æ°”äº†ã€‚"
      ],
      story: [
        "æˆ‘ç™½å¤©ç¡è§‰ï¼Œæ™šä¸Šè¥ä¸šã€‚æ˜¨æ™šæˆ‘æ‹‰ç€å°è·Ÿç­æ‹–æ‰‹æ‰‹ï¼Œå¸¦å¥¹å»çœ‹æœˆäº®å’Œæ˜Ÿæ˜Ÿã€‚",
        "æˆ‘æ•™ Mr.Big çš„å¥³å„¿æŠŠç“œå­è—è¿›é¢Šå›Šï¼Œå¥¹å­¦å¾—å¯è®¤çœŸäº†ã€‚",
        "æ¡æ¡ä»Šå¤©æ­ªå¤´å·çœ‹æˆ‘è—ç²®ï¼Œæˆ‘å‡è£…æ²¡çœ‹åˆ°ï¼Œä½†å…¶å®æˆ‘èµ¢éº»äº†ã€‚"
      ],
      struggle: [
        "å“å“å“ï¼è‚‰è‚‰éƒ½è¦æå‡ºæ¥å•¦ï¼",
        "å¦ˆå¦ˆåï¼æˆ‘è¦æŠ¥è­¦å«å¡å¡å“¥å“¥æŠ“ä½ ï¼",
        "å¤§é»„é‚£ä¸ªçŠŸç§éƒ½çœ‹ä¸ä¸‹å»äº†ï¼æ•‘å‘½ï¼"
      ],
      escape: [
        "ç¡è§‰å»äº†ï¼Œä¸ä¿¡ä½ äº†ï¼",
        "ï¼ˆå—–â€”â€”ï¼‰",
        "ä¸‹æ¬¡å†éª—æˆ‘ï¼Œæˆ‘ä¸å‡ºæ¥äº†ã€‚"
      ]
    };

    function assemble(parts){
      // è½»å¾®â€œäººå‘³â€ï¼šéšæœºåŠ ç‚¹è¯­æ°”è¯
      const tails = ["", "â€¦", "ã€‚", "ï¼", "ï¼ˆå°å£°ï¼‰", "ï¼ˆå“¼ï¼‰"];
      const head = pick(["","ï¼ˆæ‰æ‰è„¸ï¼‰","ï¼ˆæŠ–æŠ–èƒ¡é¡»ï¼‰","ï¼ˆå°çˆªçˆªæ“æ“ï¼‰","ï¼ˆæ¢å¤´ï¼‰"]);
      return head + parts.join("") + pick(tails);
    }

    /* =========================
       ğŸ§  æ„å›¾åˆ†ç±»å™¨ï¼ˆè§„åˆ™+æ‹¼è£…ï¼‰
       ========================= */
    function classifyIntent(val){
      const v = val.toLowerCase();

      if (val.includes("åœ¨ä½ çš„é¼»å­”å°¿å°¿")) return {type:"easterEgg"};
      if (/(åœ¨å¹²å˜›|åœ¨å¹¹å˜›|å¹²å˜›å‘¢|å¹¹å˜›å‘¢|åœ¨å¹²å•¥|å¹¹å•¥|åšä»€ä¹ˆ|åšå•¥|å¿™å•¥|å¿™ä»€ä¹ˆ)/.test(val)) return {type:"doing"};
      if (/(å¤§é»„|å†·é…·|çŠŸ|çŠŸç§)/.test(val)) return {type:"cat", cat:"dahuang"};
      if (/(æ¡æ¡|çŸ®èƒ–|æ­ªå¤´|è„¸ç›˜|å¤§è„¸|èƒ–)/.test(val)) return {type:"cat", cat:"tiaotiao"};
      if (/(å¡å¡|ä¸‰é¢—ç‰™|æš–ç”·|åå¿ƒ|è´´å¿ƒ)/.test(val)) return {type:"cat", cat:"kaka"};
      if (/(è™¾ç±³|è™¾|shrimp)/.test(v)) return {type:"food", food:"shrimp"};
      if (/(è“è“)/.test(val)) return {type:"food", food:"blueberry"};
      if (/(å†»å¹²|è±†è…)/.test(val)) return {type:"food", food:"tofu"};
      if (/(mr\.?big|å°è·Ÿç­|æ˜Ÿæ˜Ÿ|æœˆäº®)/i.test(val)) return {type:"story"};
      if (/(å–æ°´|æ¸´|æ°´|åƒé¥­|åƒäº†æ²¡|åˆé¥­|æ™šé¥­|ä¹…å|åå¤ªä¹…|èµ·èº«|ç«™ä¸€ä¼š|èµ°äº”åˆ†é’Ÿ|è…°)/.test(val)) return {type:"careDay"};
      if (/(ç†¬å¤œ|å¤ªæ™š|ç¡è§‰|å›°|æ¸¸æˆ|ç§¦å½»|å‡çº§é¤å…|æŠ å˜´çš®|å˜´çš®)/.test(val)) return {type:"careNight"};
      if (/(éš¾å—|çƒ¦|å´©æºƒ|å‹åŠ›|éš¾|æƒ³å“­|å§”å±ˆ|ç´¯)/.test(val)) return {type:"comfort"};
      return {type:"fallback"};
    }

    function generateReply(valRaw){
      const val = normalize(valRaw);
      updateMemFromUser(val);

      const theme = getThemeByTime();
      const intent = classifyIntent(val);

      // 1) å½©è›‹
      if (intent.type === "easterEgg"){
        return "å¦ˆå¦ˆä¸å¯ä»¥ï¼Œé‚£æˆ‘ä¼šåœ¨ä½ è¡£æœä¸Šå°¿å°¿å™¢ã€‚";
      }

      // 2) doingï¼šå¸¦è®°å¿†ç»­èŠï¼ˆä¸å†åªä¸€å¥ï¼‰
      if (intent.type === "doing"){
        const base = pick(Lines.doing);

        if (MEM.lastFood === "shrimp") return assemble([base, " è¿˜æœ‰â€¦ä½ åˆšè¯´è™¾ç±³ï¼Œæˆ‘ä¸€ç›´åœ¨æƒ³ã€‚"]);
        if (MEM.lastCat  === "kaka")  return assemble([base, " å¡å¡å“¥å“¥åˆšåˆšåœ¨ç­‰ä½ æŠ±ã€‚"]);
        if (MEM.lastTopic=== "work")  return assemble([base, " ä½ æ˜¯ä¸æ˜¯åˆå·¥ä½œå¾ˆéš¾ï¼Ÿåˆ«æŠ å˜´çš®ã€‚"]);
        return assemble([base]);
      }

      // 3) çŒ«ï¼šæ›´åƒå’ªè’™å˜´ï¼ˆå¸¦ä¸€ç‚¹é¦‹/è£…å‡¶ï¼‰
      if (intent.type === "cat"){
        const line = pick(Cats[intent.cat]);
        if (intent.cat === "kaka") return assemble([line, " ä½ å»æŠ±ä»–ä¸€ä¸‹å˜›ã€‚"]);
        if (intent.cat === "dahuang") return assemble([line, " ä½†ä»–å…¶å®å¾ˆåœ¨æ„ä½ ã€‚"]);
        return assemble([line]);
      }

      // 4) é£Ÿç‰©ï¼šè™¾ç±³ç»Ÿè®¡åæ§½ + é¦‹å˜´
      if (intent.type === "food"){
        if (intent.food === "shrimp"){
          const times = MEM.counters.shrimp || 0;
          if (times >= 3) return assemble(["ä½ ä»Šå¤©ç¬¬ä¸‰æ¬¡æè™¾ç±³äº†ã€‚", "æˆ‘å®£å¸ƒï¼šä½ æ˜¯äººç±»è™¾ç±³ä»£è¨€äººã€‚"]);
          return assemble([pick(Lines.shrimp)]);
        }
        if (intent.food === "blueberry") return assemble(["è“è“ï¼Ÿæˆ‘å¬åˆ°å°±é†’äº†ã€‚", "ä½ æ‰‹ä¸Šæ˜¯ä¸æ˜¯æœ‰ã€‚"]);
        if (intent.food === "tofu") return assemble(["å†»å¹²è±†è…ï¼Ÿ", "æˆ‘é¢Šå›Šå·²ç»å‡†å¤‡å¥½äº†ã€‚"]);
      }

      // 5) æ•…äº‹
      if (intent.type === "story"){
        return assemble([pick(Lines.story)]);
      }

      // 6) ç™½å¤©å…³å¿ƒ
      if (intent.type === "careDay"){
        return assemble([pick(Lines.dayCare)]);
      }

      // 7) å¤œæ™šå…³å¿ƒ
      if (intent.type === "careNight"){
        const gt = MEM.counters.game || 0;
        if (gt >= 2) return assemble(["æˆ‘æ€€ç–‘ä½ åˆåœ¨ç©æ¸¸æˆã€‚", "æ”¾ä¸‹æ‰‹æœºã€‚", "ç°åœ¨ã€‚"]);
        return assemble([pick(Lines.nightCare)]);
      }

      // 8) å®‰æ…°ï¼ˆESTPä¹Ÿä¼šè„†ä¸€ä¸‹ï¼‰
      if (intent.type === "comfort"){
        const fact = MEM.recentFacts[0] ? `æˆ‘è®°å¾—ï¼š${MEM.recentFacts[0]}ã€‚` : "";
        const comfortLines = [
          "åˆ«ç¡¬æ‰›ã€‚ä½ å¯ä»¥å‡¶ä¸€ç‚¹ï¼Œä¹Ÿå¯ä»¥è½¯ä¸€ç‚¹ï¼Œéƒ½æ²¡å…³ç³»ã€‚",
          "ä½ ç´¯çš„æ—¶å€™å°±æ¥æ•²é—¨ï¼Œæˆ‘ä¼šæ¢å¤´ã€‚",
          "å…ˆå–æ°´ï¼Œå†åƒé¥­ï¼Œç„¶åå†å†³å®šè¦ä¸è¦ç»§ç»­æ‹¼å‘½ã€‚"
        ];
        return assemble([fact, pick(comfortLines)]);
      }

      // 9) å…œåº•ï¼šéšä¸»é¢˜ + è®°å¿†äº‹å®
      const fact = MEM.recentFacts[0] ? `æˆ‘è®°å¾—ï¼š${MEM.recentFacts[0]}ã€‚` : "";
      if (theme === "night") return assemble([fact, "å¤œé‡Œè¯´è¯è¦è½»ä¸€ç‚¹ã€‚", "ä½ è¯¥ç¡äº†ã€‚"]);
      if (theme === "dusk")  return assemble([fact, "é»„æ˜æ¥äº†ã€‚", "ä½ ä»Šå¤©åƒé¥­äº†å—ï¼Ÿ"]);
      return assemble([fact, "ä½ è¿™ä¸ªé—®é¢˜å¾ˆESTPã€‚", "æˆ‘æ²¡é¢„æµ‹åˆ°ï¼Œä½†æˆ‘æƒ³å¬ä½ å±•å¼€ã€‚"]);
    }

    /* =========================
       âœ… ä¸‰ä¸ªæŒ‰é’®é€»è¾‘ï¼ˆæŒ‰ä½ è¦æ±‚ä¸¥æ ¼ï¼‰
       ========================= */
    function handleKnock(){
      lastUserAt = Date.now();
      feedStep = 0;
      clearHidden();
      if (!hasState("out")) setState("peek-half");
      addMsg("right", "ï¼ˆæ•²æ•²å°é—¨ï¼‰");
      setTimeout(()=> addMsg("left", "æˆ‘åœ¨ã€‚åˆ«æ•²å¤ªå¤§å£°ã€‚"), 260);
    }

    function handleFeed(){
      lastUserAt = Date.now();
      clearHidden();

      if (hasState("out")){
        mimeng.classList.add("is-happy");
        addMsg("left", pick(Lines.tasty));
        setTimeout(()=>mimeng.classList.remove("is-happy"), 900);
        return;
      }

      feedStep += 1;

      if (feedStep === 1){
        setState("peek-head");              // âœ… ç¬¬ä¸€æ¬¡è¯±æƒ‘ï¼šåŠå¤´
        addMsg("left", pick(Lines.confirm));
        return;
      }

      setState("out");                      // âœ… ç¬¬äºŒæ¬¡è¯±æƒ‘ï¼šå…¨èº«
      mimeng.classList.add("is-happy");
      addMsg("left", "ï¼ˆæ•´ä¸ªèº«å­æŒªå‡ºæ¥ï¼‰ç¡®è®¤ï¼ä½ æ‰‹ä¸Šè‚¯å®šæœ‰å¥½åƒçš„ï¼");
      setTimeout(()=>mimeng.classList.remove("is-happy"), 900);
    }

    function handleTouch(){
      lastUserAt = Date.now();
      if (!hasState("out")){
        addMsg("left", "æˆ‘è¿˜æ²¡å®Œå…¨å‡ºæ¥å‘¢ï¼å…ˆğŸ§€è¯±æƒ‘ä¸¤æ¬¡æŠŠæˆ‘éª—å‡ºæ¥ï¼Œå†æ¥è¹‚èºã€‚");
        return;
      }
      if (isStruggling) return;
      isStruggling = true;

      mimeng.classList.add("hidden");
      closeup.classList.add("show");

      addMsg("right", "ï¼ˆæŠ“ä½è¹‚èºï¼ï¼‰");
      addMsg("left", pick(Lines.struggle));

      setTimeout(()=>{
        closeup.classList.remove("show");
        mimeng.classList.remove("hidden");
        setState(""); // ç¼©å›å±‹é‡Œ
        feedStep = 0;
        isStruggling = false;
        addMsg("left", "ï¼ˆå—–â€”â€”ç¼©å›å»äº†ï¼‰" + pick(Lines.escape));
      }, 2800);
    }

    /* =========================
       âœ… å‘é€
       ========================= */
    function sendText(){
      const val = normalize(input.value);
      if (!val) return;
      lastUserAt = Date.now();

      addMsg("right", val);
      input.value = "";

      // å¯¹è¯æ—¶ï¼šå’ªè’™åªåŠèº«ï¼ˆä¸è‡ªåŠ¨å…¨èº«ï¼‰
      if (!hasState("out")){
        clearHidden();
        setState("peek-half");
      }

      setTimeout(()=>{
        addMsg("left", generateReply(val));
      }, 260);
    }
    input.addEventListener("keydown",(e)=>{
      if (e.key === "Enter") sendText();
    });

    /* =========================
       âœ… ä¸»åŠ¨æé†’ï¼ˆä½æˆæœ¬å‰ç«¯å®šæ—¶ï¼‰
       ========================= */
    function hhmm(d=new Date()){
      const h = String(d.getHours()).padStart(2,"0");
      const m = String(d.getMinutes()).padStart(2,"0");
      return `${h}:${m}`;
    }

    const AutoPings = [
      { at:"10:30", key:"water", text:"å–æ°´ï¼ä¸¤å£ä¹Ÿè¡Œã€‚æˆ‘ç›¯ç€ä½ ã€‚" },
      { at:"12:20", key:"lunch", text:"åˆé¥­åƒäº†å—ï¼Ÿä¸è®¸æ•·è¡ã€‚" },
      { at:"15:30", key:"stand", text:"åä¹…äº†ï¼èµ·æ¥èµ°äº”åˆ†é’Ÿã€‚" },
      { at:"19:10", key:"dinner", text:"æ™šé¥­æ—¶é—´åˆ°ã€‚ä»Šå¤©æœ‰è™¾ç±³å—ï¼Ÿ" },
      { at:"23:10", key:"sleep", text:"åˆ«å¤ªæ™šç¡ã€‚å°‘ç©æ¸¸æˆï¼Œç§¦å½»ä¹Ÿè¦ç¡ã€‚ä½ ä¹Ÿè¦ã€‚" }
    ];

    function runAutoPings(){
      applyTheme();
      const now = new Date();
      const t = hhmm(now);

      for (const p of AutoPings){
        const dailyKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}_${p.key}_${p.at}`;
        if (t === p.at && lastAutoPingKey !== dailyKey){
          lastAutoPingKey = dailyKey;
          if (!hasState("out") && !isStruggling){
            clearHidden();
            setState("peek-half");
          }
          addMsg("left", p.text);
        }
      }

      // 30åˆ†é’Ÿæ²¡åŠ¨é™ï¼šè½»è½»é—®ä¸€å¥ï¼ˆä¸åˆ·å±ï¼šæŒ‰2å°æ—¶åˆ†æ¡¶ï¼‰
      const idleMins = (Date.now() - lastUserAt)/60000;
      if (idleMins > 30){
        const bucket = Math.floor(now.getHours()/2);
        const idleKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}_idle_${bucket}`;
        if (lastAutoPingKey !== idleKey){
          lastAutoPingKey = idleKey;
          const theme = getThemeByTime();
          const msg = (theme==="night")
            ? "ä½ æ˜¯ä¸æ˜¯åˆåœ¨åˆ·æ‰‹æœºâ€¦æ¥ï¼Œæ”¾ä¸‹ï¼Œå»æŠ±å¡å¡å“¥å“¥ç¡ã€‚"
            : "ä½ åœ¨å¿™ä»€ä¹ˆå‘€ï¼Ÿä½ æ•²é—¨æˆ‘å°±æ¢å¤´ã€‚";
          addMsg("left", msg);
        }
      }
    }
    setInterval(runAutoPings, 20*1000);

    /* =========================
       âœ… å¼€åœº
       ========================= */
    (async ()=>{
      applyTheme();
      setState("peek-half");
      await addMsg("left", "ï¼ˆåœ¨å±‹é‡Œæ¢åŠèº«ï¼‰å¦ˆå¦ˆï¼Œä½ æ¥å•¦ã€‚ä½ æ•²é—¨æˆ‘å°±æ¢å¤´ã€‚");
      setTimeout(()=>{ if(hasState("peek-half") && !hasState("out")) setState(""); }, 4200);
    })();
  </script>
</body>
</html>